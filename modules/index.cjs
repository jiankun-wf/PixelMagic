var _=Object.defineProperty;var P=Object.getOwnPropertyDescriptor;var V=Object.getOwnPropertyNames;var q=Object.prototype.hasOwnProperty;var K=(w,t)=>{for(var e in t)_(w,e,{get:t[e],enumerable:!0})},J=(w,t,e,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of V(t))!q.call(w,s)&&s!==e&&_(w,s,{get:()=>t[s],enumerable:!(n=P(t,s))||n.enumerable});return w};var Q=w=>J(_({},"__esModule",{value:!0}),w);var W={};K(W,{pw:()=>I});module.exports=Q(W);const N=w=>{throw Error(w)};class y{readAsElement(t){const e=document.createElement("canvas");e.width=t.width,e.height=t.height;const n=e.getContext("2d");n.drawImage(t,0,0,e.width,e.height);const s=n.getImageData(0,0,e.width,e.height);return new x(s)}async readAsDataUrl(t){t||N("no url\uFF01");try{const e=await y.resolveWithUrl(t);return Promise.resolve(e)}catch(e){return Promise.reject(e)}}async readAsData(t){t.size||N("no content blob");const e=URL.createObjectURL(t);try{const n=await y.resolveWithUrl(e);return Promise.resolve(n)}catch(n){return Promise.reject(n)}}static calcResizeLinerFunc(t,e,n,s,r,o){return(1-r)*(1-o)*t+r*(1-o)*e+(1-r)*o*n+r*o*s}FILP={X:1,Y:2,XY:3};flip(t,e=this.FILP.XY){const{size:n,data:s,rows:r,cols:o}=t,{width:a,height:c}=n,h=new x(new ImageData(new Uint8ClampedArray(r*o*4),a,c)),u=r%2===0?Math.floor(r/2):Math.floor(r/2)+1,R=o%2===0?Math.floor(o/2):Math.floor(o/2)+1;switch(e){case this.FILP.X:return t.recycle((d,i,l)=>{const M=o-i-1,[m,f,b,A]=d,[p,g,E,B]=t.at(M,l);h.update(i,l,p,g,E,B),h.update(M,l,m,f,b,A)},0,R,0,r),h;case this.FILP.Y:return t.recycle((d,i,l)=>{const M=r-l-1,[m,f,b,A]=d,[p,g,E,B]=t.at(i,M);h.update(i,l,p,g,E,B),h.update(i,M,m,f,b,A)},0,o,0,u),h;case this.FILP.XY:return t.recycle((d,i,l)=>{const M=o-i-1,m=r-l-1,[f,b,A,p]=d,[g,E,B,G]=t.at(M,m);h.update(i,l,g,E,B,G),h.update(M,m,f,b,A,p)},0,r,0,u),h}}clip(t,e,n,s,r){const{size:{width:o,height:a}}=t,c=Math.min(e+s,o),h=Math.min(n+r,a),u=Math.max(e,0),R=Math.max(n,0),d=new x(new ImageData(new Uint8ClampedArray(s*r*4),s,r));return d.recycle((i,l,M)=>{const[m,f,b,A]=t.at(l+u,M+R);d.update(l,M,m,f,b,A)}),d}RESIZE={INTER_NEAREST:1,INTER_LINEAR:2,INTER_CUBIC:3};resize(t,e,n,s=this.RESIZE.INTER_LINEAR){const r=new ImageData(new Uint8ClampedArray(n*e*4),e,n),o=new x(r),{size:{width:a,height:c}}=t,h=a/e,u=c/n;switch(s){case this.RESIZE.INTER_NEAREST:return o.recycle((R,d,i)=>{const l=Math.round(d*h),M=Math.round(i*u),[m,f,b,A]=t.at(l,M);o.update(d,i,m,f,b,A)}),o;case this.RESIZE.INTER_LINEAR:return o.recycle((R,d,i)=>{const l=(d+.5)*h-.5,M=(i+.5)*u-.5,m=Math.floor(l),f=Math.floor(M),b=Math.ceil(l),A=Math.ceil(M),p=l-m,g=M-f,[E,B,G,T]=t.at(m,f),[L,S,C,D]=t.at(b,f),[H,O,U,v]=t.at(m,A),[F,Y,k,X]=t.at(b,A),z=y.calcResizeLinerFunc(E,L,H,F,p,g),Z=y.calcResizeLinerFunc(B,S,O,Y,p,g),$=y.calcResizeLinerFunc(G,C,U,k,p,g),j=y.calcResizeLinerFunc(T,D,v,X,p,g);o.update(d,i,z,Z,$,j)}),o;case this.RESIZE.INTER_CUBIC:return o.recycle((R,d,i)=>{const l=Math.floor(d*h),M=Math.floor(i*u),m=l-d,f=M-i;let b=0,A=0,p=0,g=0;for(let E=-1;E<3;E++)for(let B=-1;B<3;B++){let G=l+E,T=M+B;G=Math.max(G,0),G=Math.min(G,t.rows-1),T=Math.max(T,0),T=Math.min(T,t.cols-1)}}),o}}fade(t,e,n){const r=(e==="in"?1-n:n)*255,o=r,a=r,c=r;switch(e){case"in":t.recycle((h,u,R)=>{const[d,i,l]=h;d+i+l>o+a+c&&t.update(u,R,255,255,255)});break;case"out":t.recycle((h,u,R)=>{const[d,i,l]=h;d+i+l<o+a+c&&t.update(u,R,255,255,255)});break}}native(t,e="#000000"){const n=e.slice(1),[s,r,o]=[+`0x${n.slice(0,2)}`,+`0x${n.slice(2,4)}`,+`0x${n.slice(4,6)}`];t.recycle((a,c,h)=>{const[u,R,d]=a;(u!==255||R!==255||d!==255)&&t.update(c,h,s,r,o)})}nativeRollback(t){const e=[0,0,0,0];t.recycle(n=>{const[s,r,o]=n;if(s!==255||r!==255||o!==255)return e[0]=s,e[1]=r,e[2]=o,"break"}),t.recycle((n,s,r)=>{const[o,a,c]=n;o===e[0]&&a===e[1]&&c===e[2]?t.update(s,r,255,255,255):t.update(s,r,e[0],e[1],e[2])})}dropTransparent(t,e="#FFFFFFff"){const n=e.slice(1),[s,r,o,a]=[+`0x${n.slice(0,2)}`,+`0x${n.slice(2,4)}`,+`0x${n.slice(4,6)}`,n.length>=8?+`0x${n.slice(6,8)}`:255];t.recycle((c,h,u)=>{c[3]===0&&t.update(h,u,s,r,o,a)})}colorRollback(t){t.recycle((e,n,s)=>{const[r,o,a,c]=e;t.update(n,s,255-r,255-o,255-a,255-c)})}gray(t){t.recycle((e,n,s)=>{const[r,o,a]=e,c=Math.floor(y.rgbToGray(r,o,a));t.update(n,s,c,c,c)})}medianBlur(t,e){e%2!==1&&N("size\u9700\u4E3A\u5947\u6574\u6570\uFF01");const n=-Math.floor(e/2),s=Math.abs(n),{rows:r,cols:o}=t;t.recycle((a,c,h)=>{const u={R:[],G:[],B:[],A:[]};for(let m=n;m<=s;m++){let f=c+m;if(!(f<0||f>=o))for(let b=n;b<=s;b++){let A=h+b;if(A<0||A>=r)continue;const[p,g,E,B]=t.at(f,A);u.R.push(p),u.G.push(g),u.B.push(E),u.A.push(B)}}u.R.sort((m,f)=>m-f),u.G.sort((m,f)=>m-f),u.B.sort((m,f)=>m-f),u.A.sort((m,f)=>m-f);const R=u.R.length%2!==0;let d,i,l,M;if(R){const{R:m,G:f,B:b,A}=u,p=Math.floor(m.length/2);d=m[p],i=f[p],l=b[p],M=A[p]}else{const{R:m,G:f,B:b,A}=u,p=m.length/2,g=p-1;d=Math.round((m[p]+m[g])/2),i=Math.round((f[p]+f[g])/2),l=Math.round((b[p]+b[g])/2),M=Math.round((A[p]+A[g])/2)}t.update(c,h,d,i,l)})}gaussianBlur(t,e,n=0,s=n){e%2===0&&N("size\u9700\u4E3A\u5947\u6574\u6570\uFF01"),(!n||n===0)&&(n=.3*((e-1)/2-1)+.8),(!s||s===0)&&(s=n);const r=y.calcGaussianKernel(e,n,s);if(!r.length)return;const o=Math.floor(e/2);t.recycle((a,c,h)=>{let u=0,R=0,d=0,i=0;for(let l=0;l<e;l++)for(let M=0;M<e;M++){let m=c+l-o,f=h+M-o;m=Math.max(m,0),m=Math.min(m,t.cols-1),f=Math.max(f,0),f=Math.min(f,t.rows-1);const b=r[l][M],[A,p,g,E]=t.at(m,f);u+=A*b,R+=p*b,d+=g*b,i+=E*b}t.update(c,h,Math.round(u),Math.round(R),Math.round(d),Math.round(i))})}meanBlur(t,e){e%2===0&&N("size\u9700\u4E3A\u5947\u6574\u6570\uFF01");const n=Math.floor(e/2),s=Math.pow(e,2);t.recycle((r,o,a)=>{let c=0,h=0,u=0,R=0;for(let d=0;d<e;d++)for(let i=0;i<e;i++){let l=o+d-n,M=a+i-n;l=Math.max(l,0),l=Math.min(l,t.cols-1),M=Math.max(M,0),M=Math.min(M,t.rows-1);const[m,f,b,A]=t.at(l,M);c+=m,h+=f,u+=b,R+=A}t.update(o,a,Math.round(c/s),Math.round(h/s),Math.round(u/s),Math.round(R/s))})}static LINER_CONTRAST=1.5;static BRIGHTNESS_CONTRAST=50;static SATURATION_CONTRAST=1.5;LUT(t,e){if(arguments.length===1||!e?.length){e=new Uint8ClampedArray(256);for(let n=0;n<256;n++)e[n]=Math.min(255,Math.floor(n*y.SATURATION_CONTRAST))}t.recycle((n,s,r)=>{const[o,a,c]=n;t.update(s,r,e[o],e[a],e[c])})}THRESHOLD_TYPE={BINARY:1,BINARY_INV:2,TRUNC:3,TOZERO:4,TOZERO_INV:5};THRESHOLD_MODE={THRESHOLD:1,OTSU:2,MANUAL:3};threshold(t,e,n,s=this.THRESHOLD_TYPE.BINARY,r=this.THRESHOLD_MODE.THRESHOLD){t.recycle((o,a,c)=>{const[h,u,R]=t.at(a,c),d=y.rgbToGray(h,u,R);let i;switch(r){case this.THRESHOLD_MODE.THRESHOLD:i=y.calcThresholdValue(d,e,n,s);break;case this.THRESHOLD_MODE.OTSU:i=y.calcThresholdValue(d,y.calcOtsuThreshold(t),n,s);break;case this.THRESHOLD_MODE.MANUAL:i=y.calcThresholdValue(d,e,n,s);break}t.update(a,c,i,i,i)})}dropWhite(t){t.recycle((e,n,s)=>{const[r,o,a,c]=e;r===255&&o===255&&a===255&&c!==0&&t.update(n,s,void 0,void 0,void 0,0)})}groundGlassFilter(t,e=5,n=!0){(!e||e<=0)&&N("offset \u9700\u4E3A\u6B63\u6574\u6570\uFF01");const{rows:s,cols:r}=t,o=s-e,a=r-e;for(let c=0;c<o;c++)for(let h=0;h<a;h++){const u=Math.floor(Math.random()*e),R=c+u,d=h+(n?u:Math.floor(Math.random()*e)),[i,l,M,m]=t.at(R,d);t.update(c,h,i,l,M,m)}}nostalgiaFilter(t){t.recycle((e,n,s)=>{const[r,o,a]=e,c=Math.min(.393*r+.769*o+.189*a,255),h=Math.min(.349*r+.686*o+.168*a,255),u=Math.min(.272*r+.534*o+.131*a,255);t.update(n,s,c,h,u)})}fleetingFilter(t,e=12){e=Math.round(e),e<=0&&N("\u56E0\u5B50\u5FC5\u987B\u5927\u4E8E0"),t.recycle((n,s,r)=>{const o=n[2],a=Math.sqrt(o)*e;t.update(s,r,void 0,void 0,a)})}sunLightFilter(t,e,n,s,r=150){const{rows:o,cols:a}=t;e=e||Math.floor(o/2),n=n||Math.floor(a/2),s=s||Math.min(o,a),t.recycle((c,h,u)=>{const R=Math.pow(e-h,2)+Math.pow(n-u,2);if(R<Math.pow(s,2)){const[d,i,l]=c,M=Math.round(r*(1-Math.sqrt(R)/s));t.update(h,u,Math.min(255,Math.max(0,d+M)),Math.min(255,Math.max(0,i+M)),Math.min(255,Math.max(0,l+M)))}})}static GRAY_SCALE_RED=.2989;static GRAY_SCALE_GREEN=.587;static GRAY_SCALE_BLUE=.114;static rgbToGray(t,e,n){return t*y.GRAY_SCALE_RED+e*y.GRAY_SCALE_GREEN+n*y.GRAY_SCALE_BLUE}static resolveWithUrl(t){return new Promise((e,n)=>{const s=new Image;s.addEventListener("load",()=>{const r=document.createElement("canvas");r.width=s.width,r.height=s.height;const o=r.getContext("2d");o.drawImage(s,0,0,r.width,r.height);const a=o.getImageData(0,0,r.width,r.height);e(new x(a)),s.remove(),r.remove()}),s.addEventListener("error",(...r)=>{n(r[1])}),s.setAttribute("src",t)})}static gaussianFunction(t,e,n,s){const r=-(t*t/(2*n*n)),o=-(e*e/(2*s*s));return 1/(2*Math.PI*n*s)*Math.exp(r+o)}static calcGaussianKernel(t,e,n){const s=[],r=Math.floor(t/2);let o=0;for(let a=-r;a<=r;a++){const c=r+a;s[c]=[];for(let h=-r;h<=r;h++){const u=r+h,R=y.gaussianFunction(a,h,e,n);s[c][u]=R,o+=R}}for(let a=0;a<t;a++)for(let c=0;c<t;c++)s[a][c]/=o;return s}static calcThresholdValue(t,e,n,s){let r;switch(s){case 1:r=t<e?0:n;break;case 2:r=t<e?n:0;break;case 3:r=t<e?t:e;break;case 4:r=t<e?0:t;break;case 5:r=t<e?t:0;break}return r}static calcOtsuThreshold(t){const e=new Array(256).fill(0);let n=0;t.recycle((a,c,h)=>{const[u,R,d]=a,i=y.rgbToGray(u,R,d);e[Math.floor(i)]++,n++});let s=e.map(a=>a/n),r=0,o=0;for(let a=0;a<256;a++){let c=s.slice(0,a+1).reduce((i,l)=>i+l,0),h=1-c,u=s.slice(0,a+1).map((i,l)=>l*i).reduce((i,l)=>i+l,0),R=s.slice(a+1).map((i,l)=>l*i).reduce((i,l)=>i+l,0),d=c*h*Math.pow(u/c-R/h,2);d>o&&(o=d,r=a)}return r}}class x{static minPixelSplitWidth=400;static minPixelSplitHeight=400;static group(t,e){const n=this.minPixelSplitWidth,s=this.minPixelSplitHeight,r=window.navigator.hardwareConcurrency,o=t*e;if(r<1||n<=0||s<=0||o<=0)return null;const a=n*s*r;if(o<a)return null;const c=[],h=Math.min(t,e),u=Math.min(r,Math.floor(h/Math.min(n,s))),R=Math.ceil(Math.sqrt(u)),d=Math.ceil(u/R),i=Math.floor(t/d),l=Math.floor(e/R);for(let M=0;M<R;M++)for(let m=0;m<d;m++){const f=m*i,b=M*l,A=f+Math.max(n,Math.min(t-m*i,i)),p=b+Math.max(s,Math.min(e-M*l,l));c.push({x1:f,y1:b,x2:A,y2:p})}return c}rows;cols;channels;size;data;constructor(t){this.rows=t.height,this.cols=t.width,this.size={width:t.width,height:t.height},this.channels=4,this.data=t.data}clone(){const{data:t,size:{width:e,height:n}}=this,s=new Uint8ClampedArray(t),r=new ImageData(s,e,n);return new x(r)}delete(){this.data=new Uint8ClampedArray(0)}update(t,e,...n){const{data:s}=this,r=this.getAddress(t,e);for(let o=0;o<4;o++)n[o]!==void 0&&(s[r[o]]=n[o])}getAddress(t,e){const{channels:n,cols:s}=this,r=s*e*n+t*n;return[r,r+1,r+2,r+3]}recycle(t,e=0,n=this.cols,s=0,r=this.rows){for(let o=e;o<n;o++)for(let a=s;a<r;a++)t(this.at(o,a),o,a)}at(t,e){const{data:n}=this,[s,r,o,a]=this.getAddress(t,e);return[n[s],n[r],n[o],n[a]]}imgshow(t,e=!1,n=0,s=0){const r=t instanceof HTMLCanvasElement?t:document.querySelector(t);r||N("\u65E0\u6CD5\u627E\u5230canvas\u5F53\u524D\u5143\u7D20\uFF01");const{data:o,size:a}=this,{width:c,height:h}=a,u=new ImageData(o,c,h),R=r.getContext("2d");e?(r.width=n,r.height=s,window.createImageBitmap(u,{resizeHeight:s,resizeWidth:n}).then(d=>{R.drawImage(d,0,0)})):(r.width=c,r.height=h,R.putImageData(u,0,0,0,0,r.width,r.height))}toDataUrl(t,e=1){const n=document.createElement("canvas");return this.imgshow(n),n.toDataURL(t??"image/png",e)}toBlob(t,e=1){return new Promise((n,s)=>{const r=document.createElement("canvas");this.imgshow(r),r.toBlob(o=>{if(!o||!o.size)return s(new Error("\u8F6C\u6362\u5931\u8D25\uFF1A\u4E0D\u5B58\u5728\u7684blob\u6216blob\u5927\u5C0F\u4E3A\u7A7A"));n(o)},t??"image/png",e)})}}const I=new y;
